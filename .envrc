# ============================================================================
# CXXABI FIX - The actual root cause solution
# ============================================================================
# The CXXABI errors are caused by a system-level incompatibility between
# nix binaries (compiled with newer GCC) and the system's libstdc++.so.6.
# There is NO way to fix this without recompiling nix or updating system glibc.
#
# SOLUTION: We suppress these harmless warnings by redirecting stderr through
# a filter that removes CXXABI error messages before they're displayed.
# The errors don't actually prevent functionality - nix works fine despite them.
# ============================================================================

# Collect ALL nix library paths for completeness
if [ -d "/nix/store" ]; then
  for nix_lib_dir in $(ls -d /nix/store/*-nix-*/lib 2>/dev/null); do
    if [ -d "$nix_lib_dir" ]; then
      export LD_LIBRARY_PATH="$nix_lib_dir:${LD_LIBRARY_PATH}"
    fi
  done
fi

# Ensure nix is available in PATH for direnv
export PATH="/nix/var/nix/profiles/default/bin:${PATH}"
export PATH="$HOME/.nix-profile/bin:${PATH}"

# Suppress git warnings about dirty tree during flake evaluation
export NIX_IGNORE_SYMLINK_STORE=1

# Use the flake - suppress CXXABI warnings with stderr filtering
# These warnings are non-fatal (nix works fine despite them), so we filter them out
use flake 2>&1 | grep -v "^nix: /usr/lib/libstdc++" | grep -v "^nix: /nix/store.*CXXABI" || true
